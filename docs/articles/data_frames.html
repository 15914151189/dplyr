<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Data frame performance • dplyr</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="../tidyverse.css" rel="stylesheet">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- tidyverse --><link href="../pkgdown.css" rel="stylesheet">
<script src="../jquery.sticky-kit.min.js"></script><script src="../pkgdown.js"></script><!-- mathjax --><script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-vignette">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>

      <div class="navbar-brand-container">
        <a class="navbar-brand" href="../index.html">dplyr</a>
        <small class="tidyverse">part of the <a href="http://tidyverse.org">tidyverse</a></small>
      </div>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav navbar-right">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../articles/index.html">Articles</a>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
        <li>
  <a href="https://github.com/tidyverse/dplyr">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9">
    <div class="page-header toc-ignore">
      <h1>Data frame performance</h1>
            
            <h4 class="date">2017-04-04</h4>
          </div>

    
    
<div class="contents">
<p>One of the reasons that dplyr is fast is that it’s very careful about when to make copies. This section describes how this works, and gives you some useful tools for understanding the memory usage of data frames in R.</p>
<p>The first tool we’ll use is <code>dplyr::location()</code>. It tells us the memory location of three components of a data frame object:</p>
<ul>
<li>the data frame itself</li>
<li>each column</li>
<li>each attribute</li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/location.html">location</a></span>(iris)
<span class="co">#&gt; &lt;0x7f91413bd4e8&gt;</span>
<span class="co">#&gt; Variables:</span>
<span class="co">#&gt;  * Sepal.Length: &lt;0x7f913d4a1600&gt;</span>
<span class="co">#&gt;  * Sepal.Width:  &lt;0x7f913d51e800&gt;</span>
<span class="co">#&gt;  * Petal.Length: &lt;0x7f913d527000&gt;</span>
<span class="co">#&gt;  * Petal.Width:  &lt;0x7f913d52ca00&gt;</span>
<span class="co">#&gt;  * Species:      &lt;0x7f913b618540&gt;</span>
<span class="co">#&gt; Attributes:</span>
<span class="co">#&gt;  * names:        &lt;0x7f91413bd480&gt;</span>
<span class="co">#&gt;  * row.names:    &lt;0x7f913b6139b0&gt;</span>
<span class="co">#&gt;  * class:        &lt;0x7f91413cc8f8&gt;</span></code></pre></div>
<p>It’s useful to know the memory address, because if the address changes, then you’ll know that R has made a copy. Copies are bad because they take time to create. This isn’t usually a bottleneck if you have a few thousand values, but if you have millions or tens of millions of values it starts to take significant amounts of time. Unnecessary copies are also bad because they take up memory.</p>
<p>R tries to avoid making copies where possible. For example, if you just assign <code>iris</code> to another variable, it continues to the point same location:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">iris2 &lt;-<span class="st"> </span>iris
<span class="kw"><a href="../reference/location.html">location</a></span>(iris2)
<span class="co">#&gt; &lt;0x7f91413bd4e8&gt;</span>
<span class="co">#&gt; Variables:</span>
<span class="co">#&gt;  * Sepal.Length: &lt;0x7f913d4a1600&gt;</span>
<span class="co">#&gt;  * Sepal.Width:  &lt;0x7f913d51e800&gt;</span>
<span class="co">#&gt;  * Petal.Length: &lt;0x7f913d527000&gt;</span>
<span class="co">#&gt;  * Petal.Width:  &lt;0x7f913d52ca00&gt;</span>
<span class="co">#&gt;  * Species:      &lt;0x7f913b618540&gt;</span>
<span class="co">#&gt; Attributes:</span>
<span class="co">#&gt;  * names:        &lt;0x7f91413bd480&gt;</span>
<span class="co">#&gt;  * row.names:    &lt;0x7f913b61b240&gt;</span>
<span class="co">#&gt;  * class:        &lt;0x7f91413cc8f8&gt;</span></code></pre></div>
<p>Rather than having to compare hard to read memory locations, we can instead use the <code>dplyr::changes()</code> function to highlights changes between two versions of a data frame. The code below shows us that <code>iris</code> and <code>iris2</code> are identical: both names point to the same location in memory.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/location.html">changes</a></span>(iris2, iris)
<span class="co">#&gt; &lt;identical&gt;</span></code></pre></div>
<p>What do you think happens if you modify a single column of <code>iris2</code>? In R 3.1.0 and above, R knows to modify only that one column and to leave the others pointing to their existing locations:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">iris2$Sepal.Length &lt;-<span class="st"> </span>iris2$Sepal.Length *<span class="st"> </span><span class="dv">2</span>
<span class="kw"><a href="../reference/location.html">changes</a></span>(iris, iris2)
<span class="co">#&gt; Changed variables:</span>
<span class="co">#&gt;              old            new           </span>
<span class="co">#&gt; Sepal.Length 0x7f913d4a1600 0x7f913ca85e00</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Changed attributes:</span>
<span class="co">#&gt;              old            new           </span>
<span class="co">#&gt; row.names    0x7f913b5452c0 0x7f913b545540</span></code></pre></div>
<p>(This was not the case prior to version 3.1.0, where R created a deep copy of the entire data frame.)</p>
<p>dplyr is equally smart:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">iris3 &lt;-<span class="st"> </span><span class="kw"><a href="../reference/mutate.html">mutate</a></span>(iris, <span class="dt">Sepal.Length =</span> Sepal.Length *<span class="st"> </span><span class="dv">2</span>)
<span class="kw"><a href="../reference/location.html">changes</a></span>(iris3, iris)
<span class="co">#&gt; Changed variables:</span>
<span class="co">#&gt;              old            new           </span>
<span class="co">#&gt; Sepal.Length 0x7f913d3be600 0x7f913d4a1600</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Changed attributes:</span>
<span class="co">#&gt;              old            new           </span>
<span class="co">#&gt; class        0x7f91411399a8 0x7f91413cc8f8</span>
<span class="co">#&gt; names        0x7f9141132b48 0x7f91413bd480</span>
<span class="co">#&gt; row.names    0x7f913b624e60 0x7f913b6250e0</span></code></pre></div>
<p>It creates only one new column while all the other columns continue to point at their original locations. You might notice that the attributes are still copied. However, this has little impact on performance. Because attributes are usually short vectors, the internal dplyr code needed to copy them is also considerably simpler.</p>
<p>dplyr never makes copies unless it has to:</p>
<ul>
<li><p><code><a href="../reference/tbl_df.html">tbl_df()</a></code> and <code><a href="../reference/group_by.html">group_by()</a></code> don’t copy columns</p></li>
<li><p><code><a href="../reference/select.html">select()</a></code> never copies columns, even when you rename them</p></li>
<li><p><code><a href="../reference/mutate.html">mutate()</a></code> never copies columns, except when you modify an existing column</p></li>
<li><p><code><a href="../reference/arrange.html">arrange()</a></code> must always copy all columns because you’re changing the order of every one. This is an expensive operation for big data, but you can generally avoid it using the order argument to <a href="window-functions.html">window functions</a></p></li>
<li><p><code><a href="../reference/summarise.html">summarise()</a></code> creates new data, but it’s usually at least an order of magnitude smaller than the original data.</p></li>
</ul>
<p>In short, dplyr lets you work with data frames with very little memory overhead.</p>
<p>data.table takes this idea one step further: it provides functions that modify a data table in place. This avoids the need to make copies of pointers to existing columns and attributes, and speeds up operations when you have many columns. dplyr doesn’t do this with data frames (although it could) because I think it’s safer to keep data immutable: even if the resulting data frame shares practically all the data of the original data frame, all dplyr data frame methods return a new data frame.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
      </div>

</div>


      <footer><div class="tidyverse">
  <p>dplyr is a part of the <strong>tidyverse</strong>, an ecosystem of packages designed with common APIs and a shared philosophy. Learn more at <a href="http://tidyverse.org">tidyverse.org</a>.</p>
</div>

<div class="author">
  <p>Developed by <a href="http://hadley.nz">Hadley Wickham</a>, Romain Francois, <a href="https://www.rstudio.com"><img src="http://tidyverse.org/rstudio-logo.svg" height="24"></a>.</p>
  <p>Site built by <a href="http://hadley.github.io/pkgdown/">pkgdown</a>.</p>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-67989-18', 'auto');
  ga('send', 'pageview');
</script></footer>
</div>

  </body>
</html>
